<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>進階造型 QR Code 產生器</title>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; }
        /* 色彩選擇器的樣式優化 */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 42px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border-radius: 0.375rem;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden p-6 md:p-8 flex flex-col md:flex-row gap-8">
        
        <div class="w-full md:w-1/2 space-y-5">
             <h2 class="text-2xl font-bold text-slate-800 mb-4">QR Code 設計師</h2>
            
            <div class="space-y-3 p-4 bg-slate-50 rounded-lg border">
                <h3 class="font-semibold text-slate-700">1. 基本資料</h3>
                <div>
                    <label class="block text-sm font-medium text-slate-600">網址 (URL)</label>
                    <input type="text" id="url-input" placeholder="https://your-website.com" value="https://www.google.com"
                        class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">標題文字</label>
                    <input type="text" id="title-input" placeholder="輸入標題" value="掃描我"
                        class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
            </div>

            <div class="space-y-3 p-4 bg-slate-50 rounded-lg border">
                <h3 class="font-semibold text-slate-700">2. 外觀樣式</h3>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600">QR Code 造型</label>
                        <select id="shape-style" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="square">標準方形</option>
                            <option value="rounded">圓角方塊</option>
                            <option value="dots">圓點風格</option>
                            <option value="extra-rounded">超圓滑</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600">文字位置</label>
                        <select id="text-position" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="top">上方</option>
                            <option value="bottom" selected>下方</option>
                            <option value="middle">中間 (遮擋)</option>
                        </select>
                    </div>
                </div>
            </div>

             <div class="space-y-3 p-4 bg-slate-50 rounded-lg border">
                <h3 class="font-semibold text-slate-700">3. 色彩設定</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                         <label class="block text-sm font-medium text-slate-600 mb-1">QR 顏色</label>
                         <input type="color" id="fg-color" value="#4f46e5">
                    </div>
                    <div>
                         <label class="block text-sm font-medium text-slate-600 mb-1">背景顏色</label>
                         <input type="color" id="bg-color" value="#ffffff">
                    </div>
                    <div>
                         <label class="block text-sm font-medium text-slate-600 mb-1">文字顏色</label>
                         <input type="color" id="text-color" value="#1e293b">
                    </div>
                </div>
            </div>

            <button onclick="generateQR()" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 font-bold text-lg shadow-md active:scale-95">
                產生 QR Code
            </button>
        </div>

        <div class="w-full md:w-1/2 flex flex-col items-center justify-center bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 p-4 min-h-[400px]">
            <h3 class="text-lg font-medium text-slate-500 mb-4">預覽結果</h3>
            
            <div class="bg-white p-2 shadow-sm rounded-lg">
                 <canvas id="final-canvas" width="300" height="300" class="border"></canvas>
            </div>

            <div class="mt-6 space-x-4">
                <button id="download-btn" onclick="downloadQR()" class="bg-white text-indigo-600 border border-indigo-600 py-2 px-6 rounded-full hover:bg-indigo-50 transition text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    下載圖片 (PNG)
                </button>
            </div>
        </div>
    </div>

    <script>
        // 初始化 QR Code Styling 物件
        let qrCodeStyling = new QRCodeStyling({
            width: 300,
            height: 300,
            type: "canvas",
            data: "https://www.google.com",
            imageOptions: {
                crossOrigin: "anonymous",
                margin: 10
            },
            dotsOptions: { color: "#4f46e5", type: "rounded" },
            backgroundOptions: { color: "#ffffff" },
            cornersSquareOptions: { type: "extra-rounded", color: "#4f46e5" },
            cornersDotOptions: { type: "dot", color: "#4f46e5" },
            qrOptions: {
                errorCorrectionLevel: 'H' // 高容錯率
            }
        });

        // 頁面載入時先執行一次
        window.onload = () => {
            setTimeout(generateQR, 100);
        }

        async function generateQR() {
            const url = document.getElementById('url-input').value;
            const title = document.getElementById('title-input').value;
            const position = document.getElementById('text-position').value;
            const shapeStyle = document.getElementById('shape-style').value;
            const fgColor = document.getElementById('fg-color').value;
            const bgColor = document.getElementById('bg-color').value;
            const textColor = document.getElementById('text-color').value;

            if (!url) { alert("請輸入網址！"); return; }

            document.getElementById('download-btn').disabled = true;
            const finalCanvas = document.getElementById('final-canvas');
            const ctx = finalCanvas.getContext('2d');

            // --- 步驟 1: 設定 QR Code 樣式 ---
            let dotsType = 'square';
            let cornersType = 'square';
            let cornersDotType = 'square';

            switch(shapeStyle) {
                case 'rounded':
                    dotsType = 'rounded'; cornersType = 'extra-rounded'; cornersDotType = 'dot'; break;
                case 'dots':
                    dotsType = 'dots'; cornersType = 'extra-rounded'; cornersDotType = 'dot'; break;
                case 'extra-rounded':
                    dotsType = 'classy-rounded'; cornersType = 'extra-rounded'; cornersDotType = 'dot'; break;
                default: // square
                    dotsType = 'square'; cornersType = 'square'; cornersDotType = 'square'; break;
            }

            qrCodeStyling.update({
                data: url,
                dotsOptions: { color: fgColor, type: dotsType },
                backgroundOptions: { color: bgColor },
                cornersSquareOptions: { color: fgColor, type: cornersType },
                cornersDotOptions: { color: fgColor, type: cornersDotType }
            });

            // --- 步驟 2: 取得生成的 QR Code 圖片資料 (Blob) ---
            // 這裡需要等待函式庫產生圖片
            const qrBlob = await qrCodeStyling.getRawData('png');
            const qrImg = new Image();
            qrImg.src = URL.createObjectURL(qrBlob);

            // --- 步驟 3: 組合文字與 QR Code 到最終畫布 ---
            qrImg.onload = () => {
                const qrSize = 300; // 與上面設定一致
                const paddingY = title ? 60 : 20; // 有標題時增加垂直空間
                const paddingX = 20;
                
                finalCanvas.width = qrSize + paddingX;
                
                if (position === 'top' || position === 'bottom') {
                    finalCanvas.height = qrSize + paddingY;
                } else {
                    finalCanvas.height = qrSize + 20;
                }

                // 1. 填滿背景色
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

                // 2. 繪製 QR Code 圖片
                let qrY = 10;
                if (position === 'top') qrY = paddingY - 10;
                if (position === 'middle') qrY = 10;
                ctx.drawImage(qrImg, paddingX/2, qrY, qrSize, qrSize);

                // 3. 繪製文字
                if (title) {
                    ctx.fillStyle = textColor;
                    ctx.font = "bold 22px 'Microsoft JhengHei', Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";

                    let textY;
                    if (position === 'top') {
                        textY = (paddingY / 2);
                    } else if (position === 'bottom') {
                        textY = finalCanvas.height - (paddingY / 2);
                    } else if (position === 'middle') {
                        textY = finalCanvas.height / 2;
                        // 在中間文字後方加一個背景色塊，確保文字清晰
                        const textWidth = ctx.measureText(title).width + 20;
                        const textBgHeight = 40;
                        ctx.fillStyle = bgColor;
                        ctx.fillRect((finalCanvas.width - textWidth) / 2, textY - textBgHeight/2, textWidth, textBgHeight);
                        // 把文字顏色改回來
                        ctx.fillStyle = textColor;
                    }
                    ctx.fillText(title, finalCanvas.width / 2, textY);
                }
                
                document.getElementById('download-btn').disabled = false;
                URL.revokeObjectURL(qrImg.src); // 釋放記憶體
            };
        }

        function downloadQR() {
            const canvas = document.getElementById('final-canvas');
            const link = document.createElement('a');
            link.download = 'custom-qrcode.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
