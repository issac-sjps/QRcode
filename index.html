<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新莊國小 QRcode 產生器</title>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; }
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 42px;
            padding: 0;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-10">

    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row border border-gray-200">
        
        <div class="w-full md:w-5/12 p-6 md:p-8 bg-white">
             <div class="mb-8">
                <h1 class="text-3xl font-black text-blue-900 tracking-tight">新莊國小</h1>
                <h2 class="text-xl font-bold text-blue-600">QRcode 產生器</h2>
                <div class="h-1 w-20 bg-blue-500 mt-2 rounded-full"></div>
             </div>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">目標網址 (URL)</label>
                    <input type="text" id="url-input" placeholder="請輸入網址" value="https://www.sjps.kh.edu.tw/"
                        class="auto-update w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">標題文字</label>
                    <input type="text" id="title-input" placeholder="例如：校網首頁" value="新莊國小"
                        class="auto-update w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">QR 造型</label>
                        <select id="shape-style" class="auto-update w-full px-3 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="square">標準方形</option>
                            <option value="rounded">圓角方塊</option>
                            <option value="dots">圓點風格</option>
                            <option value="extra-rounded">超圓滑風格</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">文字位置</label>
                        <select id="text-position" class="auto-update w-full px-3 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="top">上方</option>
                            <option value="bottom" selected>下方</option>
                            <option value="middle">中間</option>
                        </select>
                    </div>
                </div>

                 <div class="p-5 bg-blue-50 rounded-2xl border border-blue-100 space-y-4">
                    <h3 class="text-xs font-black text-blue-800 uppercase tracking-widest">色彩自定義</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                             <label class="block text-[10px] font-bold text-gray-500 mb-1 text-center">QR 顏色</label>
                             <input type="color" id="fg-color" value="#000000" class="auto-update">
                        </div>
                        <div>
                             <label class="block text-[10px] font-bold text-gray-500 mb-1 text-center">背景顏色</label>
                             <input type="color" id="bg-color" value="#ffffff" class="auto-update">
                        </div>
                        <div>
                             <label class="block text-[10px] font-bold text-gray-500 mb-1 text-center">文字顏色</label>
                             <input type="color" id="text-color" value="#000000" class="auto-update">
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-[10px] text-gray-400 mt-6 text-center">修改內容後，右側預覽會自動即時更新</p>
        </div>

        <div class="w-full md:w-7/12 bg-gray-50 flex flex-col items-center justify-center p-8 border-l border-gray-100">
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                
                <div class="relative bg-white p-4 shadow-xl rounded-2xl">
                     <canvas id="final-canvas"></canvas>
                </div>
            </div>

            <div class="mt-10 w-full max-w-xs">
                <button onclick="downloadQR()" class="w-full flex items-center justify-center gap-3 bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl shadow-lg hover:shadow-blue-200 transition-all active:scale-95 font-bold text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    下載 QR Code 圖片
                </button>
            </div>
            <p class="mt-4 text-sm text-gray-400 font-medium">支援智慧型手機與掃描器辨識</p>
        </div>
    </div>

    <script>
        // 初始化 QR Code Styling 引擎
        let qrCodeStyling = new QRCodeStyling({
            width: 300,
            height: 300,
            type: "canvas",
            data: "https://www.sjps.kh.edu.tw/",
            dotsOptions: { color: "#000000", type: "square" },
            backgroundOptions: { color: "#ffffff" },
            qrOptions: { errorCorrectionLevel: 'H' }
        });

        // 監聽所有輸入欄位
        document.querySelectorAll('.auto-update').forEach(el => {
            el.addEventListener('input', generateQR);
            el.addEventListener('change', generateQR);
        });

        // 網頁載入後先產生一次
        window.onload = () => { generateQR(); }

        async function generateQR() {
            const url = document.getElementById('url-input').value || " ";
            const title = document.getElementById('title-input').value;
            const position = document.getElementById('text-position').value;
            const shapeStyle = document.getElementById('shape-style').value;
            const fgColor = document.getElementById('fg-color').value;
            const bgColor = document.getElementById('bg-color').value;
            const textColor = document.getElementById('text-color').value;

            const finalCanvas = document.getElementById('final-canvas');
            const ctx = finalCanvas.getContext('2d');

            // QR 樣式轉換邏輯
            let dotsType = 'square', cornersType = 'square', cornersDotType = 'square';
            if (shapeStyle === 'rounded') { dotsType = 'rounded'; cornersType = 'extra-rounded'; cornersDotType = 'dot'; }
            else if (shapeStyle === 'dots') { dotsType = 'dots'; cornersType = 'extra-rounded'; cornersDotType = 'dot'; }
            else if (shapeStyle === 'extra-rounded') { dotsType = 'classy-rounded'; cornersType = 'extra-rounded'; cornersDotType = 'dot'; }

            // 更新核心數據
            qrCodeStyling.update({
                data: url,
                dotsOptions: { color: fgColor, type: dotsType },
                backgroundOptions: { color: bgColor },
                cornersSquareOptions: { color: fgColor, type: cornersType },
                cornersDotOptions: { color: fgColor, type: cornersDotType }
            });

            // 取得 QR Code 並與文字組合
            const qrBlob = await qrCodeStyling.getRawData('png');
            const qrImg = new Image();
            qrImg.src = URL.createObjectURL(qrBlob);

            qrImg.onload = () => {
                const qrSize = 300;
                const textSpace = title ? 60 : 20;
                const canvasPadding = 20;
                
                finalCanvas.width = qrSize + canvasPadding;
                // 若文字在中間，則不需要額外上下空間
                finalCanvas.height = (position === 'middle') ? (qrSize + 20) : (qrSize + textSpace);

                // 繪製背景
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

                // 繪製 QR
                let qrY = (position === 'top') ? (textSpace - 10) : 10;
                ctx.drawImage(qrImg, canvasPadding/2, qrY, qrSize, qrSize);

                // 繪製標題文字
                if (title) {
                    ctx.fillStyle = textColor;
                    ctx.font = "bold 24px 'Microsoft JhengHei', Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";

                    let textY;
                    if (position === 'top') {
                        textY = textSpace / 2;
                    } else if (position === 'bottom') {
                        textY = finalCanvas.height - (textSpace / 2);
                    } else if (position === 'middle') {
                        textY = finalCanvas.height / 2;
                        // 中間文字背景擋板
                        const textWidth = ctx.measureText(title).width + 20;
                        ctx.fillStyle = bgColor;
                        ctx.fillRect((finalCanvas.width - textWidth) / 2, textY - 20, textWidth, 40);
                        ctx.fillStyle = textColor;
                    }
                    ctx.fillText(title, finalCanvas.width / 2, textY);
                }
                URL.revokeObjectURL(qrImg.src);
            };
        }

        function downloadQR() {
            const canvas = document.getElementById('final-canvas');
            const link = document.createElement('a');
            link.download = 'SJPS-QRCode.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
