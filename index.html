<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新莊國小QRcode產生器</title>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; }
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 42px;
            padding: 0;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.375rem; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden p-6 md:p-8 flex flex-col md:flex-row gap-8 border border-slate-200">
        
        <div class="w-full md:w-1/2 space-y-6">
             <div class="border-b pb-4">
                <h2 class="text-2xl font-bold text-indigo-900">新莊國小QRcode產生器</h2>
                <p class="text-sm text-slate-500 mt-1">修改下方欄位，右側將自動即時更新</p>
             </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700">網址 (URL)</label>
                    <input type="text" id="url-input" placeholder="請輸入網址..." value="https://www.hcps.ntpc.edu.tw/"
                        class="auto-update mt-1 block w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700">標題文字</label>
                    <input type="text" id="title-input" placeholder="例如：新莊國小首頁" value="新莊國小"
                        class="auto-update mt-1 block w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700">造型風格</label>
                    <select id="shape-style" class="auto-update mt-1 block w-full px-3 py-2 bg-slate-50 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="square">標準方形</option>
                        <option value="rounded">圓角方塊</option>
                        <option value="dots">圓點風格</option>
                        <option value="extra-rounded">超圓滑風格</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700">文字位置</label>
                    <select id="text-position" class="auto-update mt-1 block w-full px-3 py-2 bg-slate-50 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="top">標題在上方</option>
                        <option value="bottom" selected>標題在下方</option>
                        <option value="middle">文字在中間 (遮蓋)</option>
                    </select>
                </div>
            </div>

             <div class="bg-indigo-50 p-4 rounded-xl space-y-3">
                <h3 class="text-sm font-bold text-indigo-800 uppercase tracking-wider">色彩自定義</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                         <label class="block text-xs font-medium text-slate-600 mb-1">QR 顏色</label>
                         <input type="color" id="fg-color" value="#000000" class="auto-update">
                    </div>
                    <div>
                         <label class="block text-xs font-medium text-slate-600 mb-1">背景顏色</label>
                         <input type="color" id="bg-color" value="#ffffff" class="auto-update">
                    </div>
                    <div>
                         <label class="block text-xs font-medium text-slate-600 mb-1">文字顏色</label>
                         <input type="color" id="text-color" value="#000000" class="auto-update">
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full md:w-1/2 flex flex-col items-center justify-center bg-slate-100 rounded-2xl border-2 border-dashed border-slate-300 p-6">
            <div class="relative group">
                <div class="bg-white p-3 shadow-2xl rounded-xl transition-transform duration-300 group-hover:scale-105">
                     <canvas id="final-canvas" width="300" height="300"></canvas>
                </div>
            </div>

            <div class="mt-8">
                <button id="download-btn" onclick="downloadQR()" class="flex items-center gap-2 bg-indigo-600 text-white py-2 px-8 rounded-full hover:bg-indigo-700 transition-all shadow-lg active:scale-95 font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    下載圖片
                </button>
            </div>
            <p class="text-xs text-slate-400 mt-4">提示：滑鼠右鍵亦可另存圖片</p>
        </div>
    </div>

    <script>
        // 初始化 QR Code Styling
        let qrCodeStyling = new QRCodeStyling({
            width: 300,
            height: 300,
            type: "canvas",
            data: "https://www.hcps.ntpc.edu.tw/",
            dotsOptions: { color: "#000000", type: "square" },
            backgroundOptions: { color: "#ffffff" },
            qrOptions: { errorCorrectionLevel: 'H' }
        });

        // 綁定所有帶有 .auto-update 類別的輸入項
        document.querySelectorAll('.auto-update').forEach(element => {
            // 'input' 事件會在打字或拉動顏色條時立刻觸發
            element.addEventListener('input', generateQR);
            // 'change' 確保下拉選單正確觸發
            element.addEventListener('change', generateQR);
        });

        // 首次執行
        window.onload = () => { generateQR(); }

        async function generateQR() {
            const url = document.getElementById('url-input').value || " ";
            const title = document.getElementById('title-input').value;
            const position = document.getElementById('text-position').value;
            const shapeStyle = document.getElementById('shape-style').value;
            const fgColor = document.getElementById('fg-color').value;
            const bgColor = document.getElementById('bg-color').value;
            const textColor = document.getElementById('text-color').value;

            const finalCanvas = document.getElementById('final-canvas');
            const ctx = finalCanvas.getContext('2d');

            // --- 樣式邏輯 ---
            let dotsType = 'square', cornersType = 'square', cornersDotType = 'square';
            if (shapeStyle === 'rounded') { dotsType = 'rounded'; cornersType = 'extra-rounded'; cornersDotType = 'dot'; }
            else if (shapeStyle === 'dots') { dotsType = 'dots'; cornersType = 'extra-rounded'; cornersDotType = 'dot'; }
            else if (shapeStyle === 'extra-rounded') { dotsType = 'classy-rounded'; cornersType = 'extra-rounded'; cornersDotType = 'dot'; }

            // 更新 QR Code 核心
            qrCodeStyling.update({
                data: url,
                dotsOptions: { color: fgColor, type: dotsType },
                backgroundOptions: { color: bgColor },
                cornersSquareOptions: { color: fgColor, type: cornersType },
                cornersDotOptions: { color: fgColor, type: cornersDotType }
            });

            // 取得 QR Code 圖片並組合文字
            const qrBlob = await qrCodeStyling.getRawData('png');
            const qrImg = new Image();
            qrImg.src = URL.createObjectURL(qrBlob);

            qrImg.onload = () => {
                const qrSize = 300;
                const paddingY = title ? 60 : 20;
                const paddingX = 20;
                
                finalCanvas.width = qrSize + paddingX;
                finalCanvas.height = (position === 'middle') ? (qrSize + 20) : (qrSize + paddingY);

                // 背景
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

                // QR Code 位置計算
                let qrY = (position === 'top') ? (paddingY - 10) : 10;
                ctx.drawImage(qrImg, paddingX/2, qrY, qrSize, qrSize);

                // 文字繪製
                if (title) {
                    ctx.fillStyle = textColor;
                    ctx.font = "bold 24px 'Microsoft JhengHei', Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";

                    let textY;
                    if (position === 'top') {
                        textY = paddingY / 2;
                    } else if (position === 'bottom') {
                        textY = finalCanvas.height - (paddingY / 2);
                    } else if (position === 'middle') {
                        textY = finalCanvas.height / 2;
                        // 中間文字背景擋板
                        const textWidth = ctx.measureText(title).width + 16;
                        ctx.fillStyle = bgColor;
                        ctx.fillRect((finalCanvas.width - textWidth) / 2, textY - 20, textWidth, 40);
                        ctx.fillStyle = textColor;
                    }
                    ctx.fillText(title, finalCanvas.width / 2, textY);
                }
                URL.revokeObjectURL(qrImg.src);
            };
        }

        function downloadQR() {
            const canvas = document.getElementById('final-canvas');
            const link = document.createElement('a');
            link.download = 'hcps-qrcode.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
